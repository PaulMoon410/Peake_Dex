<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEK Dex - Home</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(120deg, #f8f8fa 0%, #e0e7ff 100%);
            margin: 0;
            padding: 0;
        }
        header {
            background: #2d3748;
            color: #fff;
            padding: 2rem 1rem 1rem 1rem;
            text-align: center;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            box-shadow: 0 2px 12px rgba(44,62,80,0.08);
        }
        header h1 {
            margin: 0 0 0.5rem 0;
            font-size: 2.5rem;
            letter-spacing: 2px;
        }
        header p {
            margin: 0;
            font-size: 1.2rem;
            color: #cbd5e1;
        }
        .container {
            max-width: 700px;
            margin: 2.5rem auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(44,62,80,0.10);
            padding: 2.5rem 2rem 2rem 2rem;
        }
        .pair-list {
            display: flex;
            flex-wrap: wrap;
            gap: 1.2rem;
            margin-top: 2rem;
            justify-content: center;
        }
        .pair-card {
            background: #f1f5fa;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(44,62,80,0.06);
            padding: 1.5rem 2rem;
            min-width: 180px;
            text-align: center;
            transition: box-shadow 0.2s, background 0.2s;
        }
        .pair-card:hover {
            background: #e0e7ff;
            box-shadow: 0 4px 16px rgba(44,62,80,0.12);
        }
        .pair-link {
            text-decoration: none;
            color: #3730a3;
            font-size: 1.2rem;
            font-weight: 600;
            letter-spacing: 1px;
            display: block;
        }
        .pair-link:hover {
            color: #6366f1;
        }
        @media (max-width: 700px) {
            .container { padding: 1rem; }
            header { padding: 1.5rem 0.5rem 1rem 0.5rem; }
            .pair-list { flex-direction: column; gap: 0.7rem; }
        }
    </style>
</head>
<body>
    <header>
        <h1>PEK Dex</h1>
        <p>Welcome! Select a trading pair to view its order book, trades, and place orders.</p>
        <div id="user-info" style="margin-top: 1rem;">
            <div id="login-section">
                <input type="text" id="username-input" placeholder="Enter Hive username" style="padding: 0.5rem; margin-right: 0.5rem; border-radius: 6px; border: 1px solid #cbd5e1;">
                <button onclick="login()" style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">Sign In</button>
            </div>
            <div id="user-dashboard" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <strong id="logged-username"></strong>
                        <button onclick="refreshUserBalances()" style="background: #10b981; color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem; font-size: 0.8rem;">â†»</button>
                        <button onclick="logout()" style="background: #ef4444; color: white; border: none; padding: 0.3rem 0.8rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem; font-size: 0.9rem;">Sign Out</button>
                    </div>
                    <div id="balance-info" style="text-align: right; font-size: 0.9rem;">
                        <div>Loading balances...</div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <div class="container">
        <h2>Available Trading Pairs</h2>
        <div class="pair-list" id="pair-list"></div>
        <div id="error-message" style="color:#b91c1c; margin-top:1.5rem; text-align:center; display:none;"></div>
    </div>
    <script>
        // Configuration - Update this to point to your server
        const API_BASE_URL = 'http://74.208.146.37:8080';
        const CORS_PROXIES = [
            'https://api.allorigins.win/raw?url=',           // Primary proxy
            'https://corsproxy.io/?',                         // Backup proxy 1
            'https://cors-anywhere.herokuapp.com/',          // Backup proxy 2 (requires demo access)
        ];
        
        async function fetchPairs() {
            // Check if we're on HTTPS and trying to access HTTP
            if (window.location.protocol === 'https:' && API_BASE_URL.startsWith('http:')) {
                for (let i = 0; i < CORS_PROXIES.length; i++) {
                    try {
                        // Use CORS proxy to bypass mixed content restrictions
                        const proxyUrl = CORS_PROXIES[i] + encodeURIComponent(`${API_BASE_URL}/api/pairs`);
                        const response = await fetch(proxyUrl);
                        if (!response.ok) throw new Error('Proxy failed: ' + response.status);
                        const data = await response.json();
                        return data.pairs || data;
                    } catch (e) {
                        console.log(`Proxy ${i + 1} failed:`, e.message);
                        if (i === CORS_PROXIES.length - 1) {
                            // All proxies failed, show error and use mock data
                            showError('All CORS proxies failed. Using demo data.', 
                                     'Tried: ' + CORS_PROXIES.join(', ') + '\n\nAlternatives:\n1. Access via http://geocities.ws/peakecoin/pekdex/\n2. Set up HTTPS on your backend');
                            return getMockPairs();
                        }
                    }
                }
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/pairs`);
                if (!response.ok) throw new Error('Failed to fetch pairs: ' + response.status + ' ' + response.statusText);
                const data = await response.json();
                // Support both {pairs: [...]} and [...] formats
                return data.pairs || data;
            } catch (e) {
                showError('Error fetching pairs: ' + e.message, e.stack);
                return getMockPairs(); // Fallback to mock data
            }
        }
        
        function getMockPairs() {
            // Mock data for demonstration when API is unavailable
            return [
                {"base": "PEK", "quote": "SWAP.HIVE"},
                {"base": "PEK", "quote": "SWAP.BTC"},
                {"base": "PEK", "quote": "SWAP.LTC"},
                {"base": "PEK", "quote": "SWAP.ETH"},
                {"base": "PEK", "quote": "SWAP.DOGE"}
            ];
        }
        
        // User authentication and balance functions
        let currentUser = null;
        
        function login() {
            const username = document.getElementById('username-input').value.trim();
            if (!username) {
                alert('Please enter a username');
                return;
            }
            
            currentUser = username;
            localStorage.setItem('pekdex_user', username);
            
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('user-dashboard').style.display = 'block';
            document.getElementById('logged-username').textContent = username;
            
            fetchUserBalances(username);
        }
        
        function logout() {
            currentUser = null;
            localStorage.removeItem('pekdex_user');
            
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('user-dashboard').style.display = 'none';
            document.getElementById('username-input').value = '';
        }
        
        async function fetchUserBalances(username) {
            const balanceDiv = document.getElementById('balance-info');
            balanceDiv.innerHTML = 'Loading balances...';
            
            try {
                let url = `${API_BASE_URL}/api/balance?username=${encodeURIComponent(username)}`;
                
                // Use CORS proxy if needed
                if (window.location.protocol === 'https:' && API_BASE_URL.startsWith('http:')) {
                    for (let i = 0; i < CORS_PROXIES.length; i++) {
                        try {
                            const proxyUrl = CORS_PROXIES[i] + encodeURIComponent(url);
                            const response = await fetch(proxyUrl);
                            if (response.ok) {
                                const data = await response.json();
                                displayBalances(data.balances || {});
                                return;
                            }
                        } catch (e) {
                            console.log(`Balance proxy ${i + 1} failed:`, e.message);
                        }
                    }
                    // Fallback to mock balances
                    displayBalances({
                        'HIVE': '1.234',
                        'PEK': '1000.0000',
                        'SWAP.HIVE': '5.678',
                        'SWAP.BTC': '0.00012345'
                    });
                    return;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                displayBalances(data.balances || {});
                
            } catch (e) {
                balanceDiv.innerHTML = `<div style="color: #ef4444;">Failed to load balances</div>`;
                console.error('Balance fetch error:', e);
            }
        }
        
        function displayBalances(balances) {
            const balanceDiv = document.getElementById('balance-info');
            const tokens = ['HIVE', 'PEK', 'SWAP.HIVE', 'SWAP.BTC', 'SWAP.LTC', 'SWAP.ETH', 'SWAP.DOGE'];
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.5rem;">';
            tokens.forEach(token => {
                const balance = balances[token] || '0.0000';
                html += `<div style="background: rgba(255,255,255,0.2); padding: 0.3rem 0.5rem; border-radius: 4px; text-align: center;">
                    <div style="font-weight: bold; font-size: 0.8rem;">${token}</div>
                    <div style="font-size: 0.9rem;">${parseFloat(balance).toFixed(4)}</div>
                </div>`;
            });
            html += '</div>';
            balanceDiv.innerHTML = html;
        }
        
        function refreshUserBalances() {
            if (currentUser) {
                fetchUserBalances(currentUser);
            }
        }
        
        // Check for saved login on page load
        function checkSavedLogin() {
            const savedUser = localStorage.getItem('pekdex_user');
            if (savedUser) {
                document.getElementById('username-input').value = savedUser;
                login();
            }
        }
        function renderPairList(pairs) {
            const list = document.getElementById('pair-list');
            list.innerHTML = '';
            pairs.forEach(pair => {
                // Expecting pair to be { base: 'PEK', quote: 'SWAP.HIVE' } or similar
                const card = document.createElement('div');
                card.className = 'pair-card';
                const link = document.createElement('a');
                link.className = 'pair-link';
                link.href = `pairs/pair.html?base=${encodeURIComponent(pair.base)}&quote=${encodeURIComponent(pair.quote)}`;
                link.textContent = `${pair.base} / ${pair.quote}`;
                card.appendChild(link);
                list.appendChild(card);
            });
        }
        function showError(message, code) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `<strong>${message}</strong>` + (code ? `<pre style='font-size:0.9em; background:#fee2e2; color:#7f1d1d; padding:0.5em; border-radius:6px; margin-top:0.5em;'>${code}</pre>` : '');
        }
        async function init() {
            checkSavedLogin();
            const pairs = await fetchPairs();
            if (pairs.length > 0) {
                renderPairList(pairs);
            }
        }
        init();
    </script>
</body>
</html>
